#!/bin/bash
TARGET="/home/git/builds/continuwuity"
GIT_DIR="/home/git/repos/home.shane.repos.continuwuity.git"

# Explicitly source rustup environment to ensure we get 1.90.0+
if [ -f "$HOME/.cargo/env" ]; then
    source "$HOME/.cargo/env"
fi

echo "Deploying to $TARGET..."
# Force checkout (HEAD)
git --work-tree=$TARGET --git-dir=$GIT_DIR checkout -f

# Check for [skip ci] in the last commit message
cd $TARGET || exit 1
LAST_MSG=$(git log -1 --pretty=%B)
if [[ "$LAST_MSG" == *"[skip ci]"* ]]; then
    echo "Build skipped due to [skip ci] in commit message."
    exit 0
fi

echo "Building release with $(cargo --version)..."

if cargo build --release; then
    echo "Build successful."
    echo "To install, ssh in and run 'make install'"
else
    echo "Build failed."
    exit 1
fi
